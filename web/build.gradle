import groovy.json.JsonOutput
import groovy.json.JsonSlurper

plugins {
    id 'com.moowork.node' version '1.3.1'
}

ext.moduleName = 'com.synopsys.integration.alert.web'

task cleanBundles(type: Delete) {
    File staticResourcesDirectory = new File('src/main/static')
    if (staticResourcesDirectory.exists()) {
        println "Deleting ${staticResourcesDirectory.canonicalPath}"
        staticResourcesDirectory.deleteDir()
    }
}

task updateNpmVersion(type: Task) {
    final def packageJsonFile = new File("${project.projectDir}/package.json")
    def packageSlurper = new JsonSlurper()
    def packageJson = packageSlurper.parse file("${project.projectDir}/package.json")
    if (packageJson.version != version) {
        packageJson.version = version

        final def updatedPackageJson = JsonOutput.toJson(packageJson)

        packageJsonFile.delete()
        packageJsonFile << JsonOutput.prettyPrint(updatedPackageJson)
    }
}
npm_run() {
    args = ['build']
}

tasks.npm_run.mustRunAfter(updateNpmVersion)

task webpack(type: Exec) {
    inputs.file("${project.projectDir}/package-lock.json")
    inputs.file("${project.projectDir}/webpack.config.js")
    inputs.dir("${project.projectDir}/src/main")

    commandLine "${project.projectDir}/node_modules/.bin/webpack"
}

task copyStaticWebContent(type: Copy, dependsOn: [npm_run]) {
    from "${project.projectDir}/src/css"
    from "${project.projectDir}/src/img"
    into "${project.buildDir}/resources/main/static"
}
tasks.copyStaticWebContent.dependsOn(npm_run)
tasks.clean.finalizedBy(cleanBundles)
tasks.build.dependsOn(copyStaticWebContent)
tasks.build.mustRunAfter(copyStaticWebContent)
